<script text="text/javascript">
    //global obj
    var $ = {
        body:   null,
        html:   null,
        win:    null,
        logo:   null,
        cover:  null,
        ratio:  null,
        map:    null,
        intro:  null,

        breakpoints: {
            tiny:   "tiny",
            small:  "small",
            medium: "medium",
            large:  "large",
            huge:   "huge",
        },

        size: "",

        SETUP:   {},
        LOADING: {},
        STATES:  {},
        COVER:   {},
        RESIZE:  {},
        ZOOM:    {},
        MAPBOX:  {},
        DEV: 	 {},
        UI:      {},

        SCREEN:  {
            size:        null,
            orientation: null,
            ratio:       null,
        },

        PORTRAIT:  "portrait",
        LANDSCAPE: "landscape",
    };

    //set default size
    $.size = $.breakpoints.tiny;

    $.SETUP = {
        getElements: function () {
            $.body  = document.body;
            $.html  = document;
            $.win   = window;
            $.logo  = document.getElementById("veritasLogo");
            $.cover = document.getElementById("coverSite");
            $.intro = document.getElementById("intro");
        },

        getMapBoxObjects: function () {
            $.MAPBOX.client = new MapboxClient($.MAPBOX.dataset.accessToken);
            $.MAPBOX.tiles  = mapboxgl;
            $.MAPBOX.tiles.accessToken = $.MAPBOX.api.accessToken;
            $.MAPBOX.client.listFeatures($.MAPBOX.dataset.id, {}, $.MAPBOX.datasetCallback);
        },

        mapClickHandler: function () {
            if (!$.map) $.map = document.querySelector(".mapboxgl-canvas-container");
            $.map.addEventListener('click', (event) => {
                $.ZOOM.initial();
            });
        },

        logoClickHandler: () => {
            // TODO: Make this be a UI element
            document.getElementById("talkToUs").addEventListener('click', () => {
                // TODO: This is temporary and should be a state change
                $.ZOOM.office();
            });

            // TODO: Make this be a UI element
            $.logo.addEventListener('click', (event) => {
                $.ZOOM.initial();
            });
        },
    }

    $.SUPPORTS = {
        cssFilters: function () {
            if (!Modernizr.cssfilters) { console.log("NO CSS FILTERS") }
        },

        cssPointerEvents: function () {
            if (!Modernizr.csspointerevents) { console.log("NO CSS POINTER EVENTS") }
        },

        forceTouch: function () {
            if (!Modernizr.forcetouch) { console.log("NO FORCE TOUCH") }
        },

        touchEvents: function () {
            if (!Modernizr.touchevents) { console.log("NO TOUCH EVENTS") }
        }
    }

    $.LOADING = {
        exitLoadingState: function () {
            // Get the opacity of the logo
            var logoOpacity = $.win.getComputedStyle($.logo, null).getPropertyValue("opacity");
            // Check if the logo opacity is lower then 95%, if so check again in 10 milliseconds
            if(logoOpacity < .95) { return setTimeout($.LOADING.exitLoadingState, 10);}
            // Logo is greater than 95% so remove loading animation & set loadingComplete state.
            $.STATES.loadingComplete();
        },

        logoTransitionToTop: function () {
            $.logo.classList.remove("loading");
            $.logo.classList.add("top");
            $.intro.classList.add("animateIn");
        }
    }

    $.STATES = {
        loadingComplete: function () {
            // Move the logo to the top
            $.LOADING.logoTransitionToTop();
            // We need to also remove the site cover
            $.COVER.hide();
        },

        contentLoaded: function () {
            $.SUPPORTS.cssFilters();
            $.SUPPORTS.cssPointerEvents();
            $.SUPPORTS.forceTouch();
            $.SUPPORTS.touchEvents();
        }
    }

    $.COVER = {
        show: function () { $.cover.classList.remove( "hidden" ); },
        hide: function () { $.cover.classList.add(    "hidden" ); }
    }

    $.RESIZE = {

        getScreenSize: function () {
            $.SCREEN.size = $.body.getBoundingClientRect();
        },

        getScreenOrientation: function() {
            $.SCREEN.orientation = ($.SCREEN.size.width >= $.SCREEN.size.height) ? $.LANDSCAPE : $.PORTRAIT;
        },

        //func to read/set CSS breakpoint ** may need to throttle this **
        handleResize: function () {
            console.log("Screen Resized");
            //read CSS psuedo element and it's after value
            var size = $.win.getComputedStyle($.body, ':after').getPropertyValue('content');
            //make sure to update panel size
            //check if size property changed, then update the class/remove previous setting
            if (size != $.size) {
                //loop breakpoints, find match to ensure tracking in JS
                Object.keys($.breakpoints).forEach(function(key) {
                    //match found
                    if ($.breakpoints[key] == size) {
                        //add new class, remove other
                        $.body.classList.add(size);
                        $.body.classList.remove($.size);
                        //update global var
                        $.size = size;
                    }
                });
            }
            $.RESIZE.getScreenSize();
            $.RESIZE.getScreenOrientation();
            console.log("Orientation: " + $.SCREEN.orientation);
            if ($.DEV.enabled) $.DEV.updatePanelSize();
            return null;
        }
    }

    $.ZOOM = {
        to: function (location) {
            // Easy Outs -> if we don't have what we need
            if( !location                               ) return;
            if( !$.MAPBOX.map                           ) return;
            if( location === $.MAPBOX.locations.current ) return;

            // Update the current location
            $.MAPBOX.locations.current = location;

            // Tell map to fly to location
            if($.MAPBOX.map) $.MAPBOX.map.flyTo(location);

            // Tell office marker to be active if it's selected
            $.MAPBOX.officeMarkerActive((location === $.MAPBOX.locations.office) ? true : false);

            return null;
        },

        initial: function () {
            $.MAPBOX.clearActiveMarkers();
            $.ZOOM.to($.MAPBOX.locations.initial);
        },

        office: () => {
            $.ZOOM.to($.MAPBOX.locations.office);
        }

    };

    $.MAPBOX = {
        client:   	   null,
        tiles:    	   null,
        dataset:  	   null,
        map:      	   null,
        markers:       {
            office:    null,
            locations: []
        },
        locations:     {
            current: null,
            office:  {},
            initial: {},
        },
        initialCenter: [],
        initialPitch:  0,
        initialZoom:   9.5,
        locationZoom:  13.5,
        locationPitch: 50,
        coordsOffice:  [-122.386888, 47.5791677],
        animation:     {
            speed: 2
        },
        offset:        {
            // TODO: Need to make these responsive to the window type
            y: () => 40,
            x: () => ($.SCREEN.size.width - 32) / 4
        },
        api:           {
            accessToken: "pk.eyJ1IjoiamFrZWRvYnNvbiIsImEiOiJjajdzMHAwZ2Y0amhsMnFxdTgzZzRoa280In0.S2TkU2UgGv7dcsUsmy12cw"
        },
        dataset:       {
            id: "cj9oy3jrk2uks2wpge13y8nl4",
            accessToken: "sk.eyJ1IjoiamFrZWRvYnNvbiIsImEiOiJjajhtYWkxaW4wd25kMndwZmc0ZG01b29lIn0.NPn9doCB7aiJpctcxiNiUA"
        },

        datasetCallback: function (error, dataset) {
            $.MAPBOX.dataset = dataset;
            $.MAPBOX.createMapAndEvent();
        },

        isReady: function () {
            $.SETUP.mapClickHandler();
            $.SETUP.logoClickHandler();
            $.MAPBOX.map.addSource("points", { "type": "geojson", "data": {
                    "type": "FeatureCollection",
                    "features": $.MAPBOX.dataset.features }
                });
            $.MAPBOX.setupLocations();
            $.MAPBOX.addMarkers();
            $.LOADING.exitLoadingState();
        },

        setupLocations: function () {
            $.MAPBOX.locations.office = {
                center: $.MAPBOX.coordsOffice,
                zoom:   $.MAPBOX.locationZoom,
                pitch:	$.MAPBOX.locationPitch,
                speed:  $.MAPBOX.animation.speed,
                offset: [-$.MAPBOX.offset.x(), $.MAPBOX.offset.y()] // TODO: Check! - ensure updates on Screen Resize
            }
            $.MAPBOX.locations.initial = {
                center: $.MAPBOX.initialCenter,
                zoom:   $.MAPBOX.initialZoom,
                pitch:	$.MAPBOX.initialPitch,
                speed:  $.MAPBOX.animation.speed,
                offset: [-$.MAPBOX.offset.x(), $.MAPBOX.offset.y()] // TODO: Check! - ensure updates on Screen Resize
            }
        },

        createMapAndEvent: function () {
            $.MAPBOX.getInitialCenter();
            $.MAPBOX.map = new $.MAPBOX.tiles.Map({
                    container: "map",
                    style:     "mapbox://styles/mapbox/satellite-v9?optimize=true",
                    center: $.MAPBOX.initialCenter,
                    zoom:   $.MAPBOX.initialZoom,
                    pitch:  $.MAPBOX.initialPitch,
                    interactive:        false,
                    attributionControl: false,
                    logoPosition: "bottom-right",
            });
            $.MAPBOX.initialOffset();
            $.MAPBOX.map.on("load", $.MAPBOX.isReady);
        },

        getInitialCenter: function () {
            //$.MAPBOX.locations = $.MAPBOX.dataset.features;
            var center = $.MAPBOX.dataset.features[0].geometry.coordinates;
            var bounds = {
                north: center[1],
                east:  center[0],
                south: center[1],
                west:  center[0]
            };


            $.MAPBOX.dataset.features.forEach( function (location) {
                center = location.geometry.coordinates;
                if (bounds.west  > center[0]) bounds.west  = center[0];
                if (bounds.south > center[1]) bounds.south = center[1];
                if (bounds.east  < center[0]) bounds.east  = center[0];
                if (bounds.north < center[1]) bounds.north = center[1];
            });

            var diffLong   = (bounds.east  - bounds.west)  / 2;
            var diffLat    = (bounds.south - bounds.north) / 2;
            var centerLong = bounds.west   + diffLong;
            var centerLat  = bounds.north  + diffLat;
            return $.MAPBOX.initialCenter  = [centerLong, centerLat];
        },

        initialOffset: function () {
            $.MAPBOX.map.panBy(
                [$.MAPBOX.offset.x(), -$.MAPBOX.offset.y()],
                { easing: function () { return 1 } }
            );
        },

        /**
        * Removes all active class names from makers that are set with class active.
        * @return {void}
        */
        clearActiveMarkers: () => {
            var activeMarkers = document.querySelectorAll('.active');
            for (var index = 0; index < activeMarkers.length; index++) {
                activeMarkers[index].classList.remove('active');
            }
            return null;
        },

        addMarkers: () => {
            // Add All the locations from Mapbox
            $.MAPBOX.dataset.features.forEach( function (location, index) {
                $.MAPBOX.setupMarker(location.geometry.coordinates, index);
            });
            // Add the Office, our Custom Property
            $.MAPBOX.setupMarker($.MAPBOX.locations.office.center, $.MAPBOX.dataset.features.length, true);
            // Add the center point
            // $.MAPBOX.setupMarker($.MAPBOX.locations.initial.center, $.MAPBOX.dataset.features.length+1, false);
        },

        /**
        * Setup for Marker Creation, Adds to Map, Click Events and storing in location object
        * @param  {Array}  coordinates
        * @param  {Number} index
        * @param  {Bool}   isOffice
        * @return {void}
        */
        setupMarker: (coordinates, index, isOffice = false) => {
            const htmlMarker = $.MAPBOX.createHTMLMarker(index, isOffice);
            const marker     = new $.MAPBOX.tiles.Marker(htmlMarker).setLngLat(coordinates).addTo($.MAPBOX.map);

            htmlMarker.addEventListener('click', function (event) {
                // Remove all the markers that are active & set clicked marker to active
                $.MAPBOX.clearActiveMarkers();
                htmlMarker.classList.add('active');
                // Call function & Block event from triggering Map
                $.MAPBOX.markerClicked(htmlMarker);
                event.stopPropagation();
            });

            // Early Out for Office so we don't add as a location. It's added by hand.
            if (isOffice) return null;

            // Add Location to location Object
            $.MAPBOX.locations[`location${index}`] = {
                center: coordinates,
                pitch:  $.MAPBOX.locationPitch,
                zoom:   $.MAPBOX.locationZoom,
                speed:  $.MAPBOX.animation.speed,
                offset: [-$.MAPBOX.offset.x(), $.MAPBOX.offset.y()], // Check! - ensure updates on Screen Resize
            };
            return null;
        },

        /**
        * Office Marker needs help to get active since you never click on it
        * We also clear other markers active state if this is set to active.
        * @param  {Bool}   toActive
        * @return {void}
        */
        officeMarkerActive: (toActive) => {
            const officeMarker = document.querySelector(".marker.office");
            if (toActive){
                $.MAPBOX.clearActiveMarkers();
                officeMarker.classList.add("active");
            }else{
                officeMarker.classList.remove("active");
            }
            return null
        },

        createHTMLMarker: (index, isOffice) => {
            const m  = document.createElement("div");
            const cn = (isOffice) ? "marker office" : "marker";

            m.className     = cn;
            m.index         = index;
            m.isOffice      = isOffice;
            m.style.width   = "32px";
            m.style.height  = "32px";
            m.style.cursor  = "pointer";
            m.innerHTML     = "<svg><use xlink:href='#mapMarker'></use></svg>";

            if (isOffice) {
                $.MAPBOX.markers.office = m;
            } else {
                $.MAPBOX.markers.locations[index] = m;
            }

            return m;
        },

        markerClicked: function (marker) {
            if(marker === $.MAPBOX.markers.office) return null;

            $.ZOOM.to($.MAPBOX.locations[`location${marker.index}`]);

            // secondaryTransition("show")

            return null;
        },
    }

    $.DEV = {
        enabled: true,
        //helper to vizualize page size by changing bg
        updatePanelSize: function() {
            var panel = document.getElementById('sizePanel');

            if(!panel){
                // <aside id="sizePanel"></aside>
                // createPanel by adding the aside via script
            }

            if (!$.SCREEN.size.width && !$.SCREEN.size.height) $.RESIZE.getScreenSize();
            panel.innerHTML = "<strong>" + $.size + "</strong> " + $.SCREEN.size.width + "&times;" + $.SCREEN.size.height;
        }
    }

/******************************************************************************/
/*													DOCUMENT EVENTS	          */
/******************************************************************************/

    window.addEventListener("resize", $.RESIZE.handleResize, false);

    window.addEventListener("load", (event) => {
        console.log("All resources finished loading!");
    });

    document.addEventListener("DOMContentLoaded", (event) => {
        $.SETUP.getElements();
        $.RESIZE.handleResize();
        $.SETUP.getMapBoxObjects();
    });

    // //listen for orientation changes => portrait v landscape
    // window.addEventListener("orientationchange", function () {
    //     alert("orientationchange");
    //     $.RESIZE.getScreenSize();
    //
    //     // TODO: Add these functions
    //     // $.RESIZE.getScreenOrientation();
    //     // $.RESIZE.getScreenRatio();
    //
    //     // TODO: Do this work in a function instead
    //     // if ($.screen.width / $.screen.height < 1) {
    //     //     alert("NO OFFSET --> ASPECT RATIO: " + $.screen.width/$.screen.height + " < 1");
    //     // } else {
    //     //     return null;
    //     // };
    // }, false);


</script>
